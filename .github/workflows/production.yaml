name: üõ†Ô∏èDeploy production application

on:
  pull_request: 
    branches:
      - main

permissions:
  actions: write
  contents: read
  checks: write

jobs:
  front:
      name: üåê production front
      runs-on: ubuntu-latest
      steps:
        - name: ‚¨áÔ∏è Checkout repo
          uses: actions/checkout@v4.1.1
        - name: frontend actions
          uses: ./.github/actions/workflow-actions/front-build
          with:
            tag: 'production-frontend'
            dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
            dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
            folder: frontend
  back:
      name: üõ¢ production Back
      runs-on: ubuntu-latest
      steps:
        - name: ‚¨áÔ∏è Checkout repo
          uses: actions/checkout@v4.1.1
        - name: backend actions
          uses: ./.github/actions/workflow-actions/back-build
          with:
            go-version: '1.22.1'
            build-path: './cmd/leviosa/*.go'
            test-path: './...'
            output-name: 'leviosa'
            tag: 'production-backend'
            dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
            dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
            folder: backend
  deploy:
    needs: [front, back]
    name: üöÄ Deploy production
    runs-on: [self-hosted]
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v4.1.1
      - uses: ./.github/actions/workflow-actions/deploy-app
        with:
          filter: 'production'
          app_env: 'production'
          backend_port: 3500
          port: 3000
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          aws_region: ${{ secrets.AWS_REGION }}
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          bucketname: ${{ secrets.BUCKETNAME }}
          stripe_secret_key: ${{ secrets.STRIPE_SECRET_KEY }}
          gmail_email: ${{ secrets.GMAIL_EMAIL }}
          gmail_password: ${{ secrets.GMAIL_PASSWORD }}
          google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
          google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          redis_addr: ${{ secrets.REDIS_ADDR }}
          redis_password: ${{ secrets.REDIS_PASSWORD }}
          redis_db: ${{ secrets.REDIS_DB }}
          user_encryption_key: ${{ secrets.USER_ENCRYPTION_KEY }}
          logging_salt: ${{ secrets.LOGGING_SALT }}
