name: üõ¢ Back

on:
  pull_request: 
    branches:
      - main

concurrency:
  group: ${{github.workflow}}-${{github.ref}}
  cancel-in-progress: true

permissions:
  actions: write
  contents: read
  checks: write

defaults:
  run: 
    working-directory: backend

jobs:
  gobuild:
    name: ‚¨£ Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.1'
      - name: Update CA certificates
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates
          sudo update-ca-certificates
          sudo apt install build-essential
      - name: Build go application
        env:
          CGO_ENABLED: 1
          GOOS: linux
        run: go build -ldflags="-s" -v -o myapp ./cmd/event-reservation-app/*.go

  test:
    name: üß™ Golang tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.1'
      - name: Update CA certificates
        run: |
          sudo apt-get update
          sudo apt-get install -y ca-certificates
          sudo update-ca-certificates
          sudo apt install build-essential
      - name: Unit test application
        env:
          CGO_ENABLED: 1
          GOOS: linux
        run: go test ./...

  docker-back:
    name: üê≥ Build backend application docker image
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3
      - uses: ./.github/actions/push-docker-image
        with:
          tag: 'backend'
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }} 
          dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
          folder: backend
